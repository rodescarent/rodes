<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="styles.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmación de pago</title>
</head>

<body class="page-success">

  <!-- HERO / HEADER -->
  <header class="hero hero--success">
    <div class="hero__content container">
      <h1 class="hero__title">Confirmación de pago</h1>
      <p class="hero__subtitle">Estamos validando tu pago con Stripe y registrándolo en el sistema.</p>

      <nav class="hero__quicklinks" aria-label="Accesos rápidos">
        <a class="glass-btn" href="index.html">Inicio</a>
        <a class="glass-btn" href="q5progressive.html">Reservar</a>
        <a class="glass-btn" href="contacto.html">Contacto</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <section class="section container">

      <div class="card card--success">
        <div class="success-head">
          <div class="success-icon" id="statusIcon" aria-hidden="true">⏳</div>
          <div>
            <h2 class="success-title" id="statusTitle">Validando pago…</h2>
            <p class="success-subtitle" id="statusSub"></p>
          </div>
        </div>

        <!-- Mensaje principal -->
        <div class="success-message" id="msgBox">
          <p id="msg" class="success-text">Validando sesión…</p>
          <!-- ✅ Este div se mantiene para mostrar el detalle del error/estado -->
          <div class="success-meta" id="metaLine" style="display:none;"></div>
        </div>

        <div class="success-actions">
          <a class="btn btn-ghost" href="index.html">Volver al inicio</a>
        </div>

        <!-- ✅ Mensaje de ayuda (solo aparece si NO se confirma) -->
        <div class="success-help" id="helpBox" style="display:none;">
          <div class="success-help__title">¿Tienes un problema?</div>
          <div class="success-help__text">
            Si ya pagaste y aquí no aparece confirmado, espera 1 minuto y recarga la página.
            Si sigue igual, contáctanos utilizando tu email de reservación.
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzNAOMuQdxhjkdh4Ff4pF_NeZgHYDmSKaTaXtpFd1PCLk_am0hQu4I2eVqJUjy8LwG6/exec";

    const params = new URLSearchParams(location.search);
    const session_id = params.get("session_id");

    const elMsg = document.getElementById("msg");
    const elMeta = document.getElementById("metaLine");

    const icon = document.getElementById("statusIcon");
    const title = document.getElementById("statusTitle");
    const sub = document.getElementById("statusSub");
    const msgBox = document.getElementById("msgBox");
    const helpBox = document.getElementById("helpBox");

    // kind: "loading" | "success" | "error"
    function setState(kind, mainText, metaText) {
      msgBox.classList.remove("is-success", "is-warn", "is-error", "is-loading");
      msgBox.classList.add("is-" + kind);

      if (kind === "loading") {
        icon.textContent = "⏳";
        title.textContent = "Validando pago…";
        sub.textContent = "";
        helpBox.style.display = "none";
      }

      if (kind === "success") {
        icon.textContent = "✅";
        title.textContent = "Pago exitoso";
        sub.textContent = "";
        helpBox.style.display = "none";
      }

      if (kind === "error") {
        icon.textContent = "⚠️";
        title.textContent = "Pago no confirmado";
        sub.textContent = "";
        helpBox.style.display = "block";
      }

      elMsg.textContent = mainText;

      if (metaText) {
        elMeta.style.display = "block";
        elMeta.textContent = metaText;
      } else {
        elMeta.style.display = "none";
        elMeta.textContent = "";
      }
    }

    async function run(){
      setState("loading", "Validando pago…");

      if (!session_id) {
        // ✅ Mensaje simple para el cliente + detalle en meta
        setState("error", "No pudimos validar su pago", "Detalle: No llegó session_id en la URL");
        return;
      }

      const fd = new FormData();
      fd.append("action", "confirm_paid");
      fd.append("session_id", session_id);

      try {
        const r = await fetch(WEBAPP_URL, { method:"POST", body: fd });
        const data = await r.json();

        // ✅ Caso OK
        if (data.ok && data.paid) {
          setState(
            "success",
            `Pago confirmado. Reserva #${data.row_index}.`,
            "" // sin meta en éxito
          );
          return;
        }

        // ✅ Caso NO confirmado (puede ser delay o falló)
        // Mantenemos el mensaje simple para el cliente, y dejamos el detalle en meta.
        const status = (data && data.payment_status) ? String(data.payment_status) : "unknown";
        setState(
          "error",
          "No pudimos validar su pago",
          `Detalle: payment_status=${status}`
        );

      } catch (e) {
        setState("error", "No pudimos validar su pago", "Detalle: " + String(e));
      }
    }

    run();
  </script>
</body>
</html>
