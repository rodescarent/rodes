<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="styles.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago exitoso</title>
</head>

<body class="page-success">

  <!-- HERO / HEADER (igual estilo que las otras p√°ginas) -->
  <header class="hero hero--success">
    <div class="hero__content container">
      <h1 class="hero__title">Confirmaci√≥n de pago</h1>
      <p class="hero__subtitle">Estamos validando tu pago con Stripe y registr√°ndolo en el sistema.</p>

      <nav class="hero__quicklinks" aria-label="Accesos r√°pidos">
        <a class="glass-btn" href="index.html">Inicio</a>
        <a class="glass-btn" href="q5progressive.html">Reservar</a>
        <a class="glass-btn" href="contacto.html">Contacto</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <section class="section container">

      <div class="card card--success">
        <div class="success-head">
          <div class="success-icon" id="statusIcon" aria-hidden="true">‚è≥</div>
          <div>
            <h2 class="success-title" id="statusTitle">Confirmando tu pago‚Ä¶</h2>
            <p class="success-subtitle" id="statusSub">
              Esto puede tardar unos segundos. No cierres esta pesta√±a.
            </p>
          </div>
        </div>

        <!-- Mensaje principal que actualiza el JS -->
        <div class="success-message" id="msgBox">
          <p id="msg" class="success-text">Validando sesi√≥n‚Ä¶</p>
          <div class="success-meta" id="metaLine" style="display:none;"></div>
        </div>

        <div class="success-actions">
          <a class="btn btn-ghost" href="index.html">Volver al inicio</a>
          <a class="btn btn-primary" href="q5progressive.html">Hacer otra reserva</a>
        </div>

        <div class="success-help">
          <div class="success-help__title">¬øTienes un problema?</div>
          <div class="success-help__text">
            Si ya pagaste y aqu√≠ no aparece confirmado, espera 1 minuto y recarga la p√°gina.
            Si sigue igual, cont√°ctanos con tu email de reserva.
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzNAOMuQdxhjkdh4Ff4pF_NeZgHYDmSKaTaXtpFd1PCLk_am0hQu4I2eVqJUjy8LwG6/exec";

    const params = new URLSearchParams(location.search);
    const session_id = params.get("session_id");

    const elMsg = document.getElementById("msg");
    const elMeta = document.getElementById("metaLine");

    const icon = document.getElementById("statusIcon");
    const title = document.getElementById("statusTitle");
    const sub = document.getElementById("statusSub");
    const msgBox = document.getElementById("msgBox");

    function setState(kind, mainText, metaText) {
      // kind: "loading" | "success" | "warn" | "error"
      msgBox.classList.remove("is-success", "is-warn", "is-error", "is-loading");
      msgBox.classList.add("is-" + kind);

      if (kind === "loading") {
        icon.textContent = "‚è≥";
        title.textContent = "Confirmando tu pago‚Ä¶";
        sub.textContent = "Esto puede tardar unos segundos. No cierres esta pesta√±a.";
      }
      if (kind === "success") {
        icon.textContent = "‚úÖ";
        title.textContent = "Pago exitoso";
        sub.textContent = "Tu reserva qued√≥ confirmada. ¬°Gracias!";
      }
      if (kind === "warn") {
        icon.textContent = "üïí";
        title.textContent = "A√∫n no aparece confirmado";
        sub.textContent = "A veces Stripe tarda un poco en reportar el estado.";
      }
      if (kind === "error") {
        icon.textContent = "‚ö†Ô∏è";
        title.textContent = "No pudimos confirmar el pago";
        sub.textContent = "Revisa el mensaje y, si pagaste, cont√°ctanos.";
      }

      elMsg.textContent = mainText;

      if (metaText) {
        elMeta.style.display = "block";
        elMeta.textContent = metaText;
      } else {
        elMeta.style.display = "none";
        elMeta.textContent = "";
      }
    }

    async function run(){
      setState("loading", "Validando sesi√≥n‚Ä¶");

      if (!session_id) {
        setState(
          "error",
          "No lleg√≥ session_id en la URL. Si pagaste, escr√≠benos para revisar.",
          "Tip: vuelve a Stripe y confirma que el pago termin√≥ correctamente."
        );
        return;
      }

      const fd = new FormData();
      fd.append("action", "confirm_paid");
      fd.append("session_id", session_id);

      try {
        const r = await fetch(WEBAPP_URL, { method:"POST", body: fd });
        const data = await r.json();

        if (data.ok && data.paid) {
          setState(
            "success",
            `Listo ‚úÖ Tu pago fue confirmado. Reserva #${data.row_index}.`,
            `Estado: ${data.payment_status || "paid"}`
          );
        } else {
          setState(
            "warn",
            `A√∫n no aparece como pagado (status: ${data.payment_status || "unknown"}).`,
            "Espera 1 minuto y recarga esta p√°gina."
          );
        }
      } catch (e) {
        setState(
          "error",
          "Error confirmando el pago: " + e,
          "Si el error persiste, cont√°ctanos."
        );
      }
    }
    run();
  </script>
</body>
</html>

