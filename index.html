<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reserva Audi Q5</title>
</head>
<body>

  <form
    id="reservaForm"
    method="POST"
    style="max-width:400px;margin:40px auto;padding:20px;border:1px solid #ccc;border-radius:10px;"
  >
    <h3>Reserva tu Audi Q5</h3>

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required style="width:100%;margin-bottom:10px;">

    <label>Correo:</label><br>
    <input type="email" name="email" required style="width:100%;margin-bottom:10px;">

    <label>Fecha Inicio:</label><br>
    <input type="date" name="fechaInicio" required style="width:100%;margin-bottom:10px;">

    <label>Fecha Fin:</label><br>
    <input type="date" name="fechaFin" required style="width:100%;margin-bottom:10px;">

    <!-- Campos ocultos para enviar a Sheets -->
    <input type="hidden" id="dias" name="dias">
    <input type="hidden" id="total" name="total">

    <!-- Mensaje para mostrar al cliente -->
    <p id="resultadoPrecio" style="font-weight:bold;margin-top:10px;text-align:center;"></p>

    <button type="submit" style="width:100%;padding:10px;background:#635bff;color:white;border:none;border-radius:5px;cursor:pointer;">
      Reservar y pagar nuevo
    </button>
  </form>

<script>
  // üëâ PON AQU√ç LA URL DE TU WEB APP (la de /exec)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzjiHVolIcQTgaj_0Ct56e9xk4QJvVJej-K1dKdk5F3hl88ErkvH2bkmm1hi6ur_2V1/exec";

  // üëâ PON AQU√ç TU ENLACE DE PAGO DE STRIPE
  const STRIPE_URL = "https://buy.stripe.com/3cIbJ3a3u9zL42zbwvcwg00";

  const form = document.getElementById("reservaForm");
  const inicioInput = document.querySelector('input[name="fechaInicio"]');
  const finInput   = document.querySelector('input[name="fechaFin"]');
  const diasInput  = document.getElementById("dias");
  const totalInput = document.getElementById("total");
  const resultado  = document.getElementById("resultadoPrecio");

  // Precios
  const PRECIO_SEMANA   = 100; // lunes a viernes
  const PRECIO_FINDE    = 135; // s√°bado y domingo

  function calcularPrecio() {
    const fechaInicio = inicioInput.value;
    const fechaFin    = finInput.value;

    if (!fechaInicio || !fechaFin) {
      if (resultado) resultado.textContent = "";
      diasInput.value  = "";
      totalInput.value = "";
      return false;
    }

    const inicio = new Date(fechaInicio);
    const fin    = new Date(fechaFin);

    // diferencia total en d√≠as (sin incluir el d√≠a de entrega)
    const diffTime = fin - inicio;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays <= 0) {
      if (resultado) {
        resultado.textContent = "La fecha de entrega debe ser despu√©s de la fecha de recogida.";
      }
      diasInput.value  = "";
      totalInput.value = "";
      return false;
    }

    // Contar d√≠as entre semana y fines de semana
    let diasSemana = 0;
    let diasFinde  = 0;

    // Clonamos la fecha de inicio para no modificar el original
    const cursor = new Date(inicio);

    // Recorremos desde inicio (incluido) hasta justo antes de fin
    while (cursor < fin) {
      const diaSemana = cursor.getDay(); // 0 = domingo, 6 = s√°bado

      if (diaSemana === 0 || diaSemana === 6) {
        diasFinde++;
      } else {
        diasSemana++;
      }

      cursor.setDate(cursor.getDate() + 1);
    }

    const total = (diasSemana * PRECIO_SEMANA) + (diasFinde * PRECIO_FINDE);

    // Mostrar mensaje m√°s detallado al cliente
    if (resultado) {
      resultado.innerHTML = `
        Has seleccionado <strong>${diffDays}</strong> d√≠a(s):<br>
        ${diasSemana} d√≠a(s) entre semana a CA$ ${PRECIO_SEMANA} + 
        ${diasFinde} d√≠a(s) de fin de semana a CA$ ${PRECIO_FINDE}.<br>
        <strong>Total estimado: CA$ ${total}</strong>.
      `;
    }

    // Guardamos los valores en los campos ocultos para que viajen a Sheets
    diasInput.value  = diffDays;
    totalInput.value = total;

    return true;
  }

  // Recalcular cuando el usuario cambia las fechas
  if (inicioInput) inicioInput.addEventListener("change", calcularPrecio);
  if (finInput)   finInput.addEventListener("change", calcularPrecio);

  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault(); // manejamos todo por JS

      const ok = calcularPrecio();
      if (!ok) return;

      const formData = new FormData(form);

      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          body: formData,
          mode: "no-cors" // no necesitamos leer la respuesta
        });
      } catch (err) {
        console.error("Error enviando datos al Web App:", err);
        alert("Hubo un problema guardando tu reserva. Intenta de nuevo.");
        return;
      }

      // Si todo bien, redirigimos a Stripe
      window.location.href = STRIPE_URL;
    });
  }
</script>


</body>
</html>
