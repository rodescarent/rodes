<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reserva Audi Q5</title>
</head>
<body>

<form id="reservaForm" style="max-width:420px;margin:40px auto;padding:20px;border:1px solid #ccc;border-radius:12px;">
  <h3>Reserva tu Audi Q5</h3>

  <label>Nombre:</label><br>
  <input type="text" id="nombre" required style="width:100%;margin-bottom:10px;">

  <label>Email:</label><br>
  <input type="email" id="email" required style="width:100%;margin-bottom:10px;">

  <label>Dirección de recogida:</label><br>
  <input
    type="text"
    id="pickup_address"
    required
    placeholder="Ej: 123 Queen St W, Toronto, ON"
    style="width:100%;margin-bottom:8px;"
  >

  <button
    type="button"
    id="btnVerifyMap"
    style="width:100%;padding:10px;margin-bottom:12px;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:pointer;"
  >
    Verificar / corregir en Google Maps
  </button>

  <label>Fecha Inicio:</label><br>
  <input type="date" id="fechaInicio" required style="width:100%;margin-bottom:10px;">

  <label>Fecha Fin:</label><br>
  <input type="date" id="fechaFin" required style="width:100%;margin-bottom:10px;">

  <p id="resultadoPrecio" style="font-weight:bold;margin:12px 0;text-align:center;"></p>

  <button type="submit" style="width:100%;padding:10px;background:#635bff;color:white;border:none;border-radius:8px;cursor:pointer;">
    Continuar → elegir artículos
  </button>
</form>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxUADRjw0CtSZH65fNJzkeNLyu1SB4Pq0XCqMINEgU00tt2pabBnTsjj55i4IpQDWia/exec";

  // Ajusta tus precios reales
  const PRECIO_SEMANA = 100;
  const PRECIO_FINDE  = 135;

  const nombreEl = document.getElementById("nombre");
  const emailEl  = document.getElementById("email");
  const dirEl    = document.getElementById("pickup_address");
  const fiEl     = document.getElementById("fechaInicio");
  const ffEl     = document.getElementById("fechaFin");
  const outEl    = document.getElementById("resultadoPrecio");
  const btnVerify = document.getElementById("btnVerifyMap");

  // Botón: abre Google Maps con la búsqueda de la dirección escrita
  btnVerify.addEventListener("click", () => {
    const addr = dirEl.value.trim();
    if (!addr) {
      alert("Escribe la dirección primero.");
      dirEl.focus();
      return;
    }
    const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(addr);
    window.open(url, "_blank");
  });

  function calc() {
    if (!fiEl.value || !ffEl.value) return null;

    const inicio = new Date(fiEl.value);
    const fin = new Date(ffEl.value);

    const dias = Math.ceil((fin - inicio) / (1000*60*60*24));
    if (dias <= 0) return { error: "La fecha fin debe ser después de la fecha inicio." };

    let ds=0, df=0;
    const cur = new Date(inicio);
    while (cur < fin) {
      const d = cur.getDay();
      (d===0 || d===6) ? df++ : ds++;
      cur.setDate(cur.getDate()+1);
    }
    const auto_total = ds*PRECIO_SEMANA + df*PRECIO_FINDE;
    return { dias, ds, df, auto_total };
  }

  function render() {
    const r = calc();
    if (!r) { outEl.textContent=""; return; }
    if (r.error) { outEl.textContent=r.error; return; }
    outEl.innerHTML = `${r.dias} día(s) — <strong>Total auto: CA$ ${r.auto_total}</strong>`;
  }

  fiEl.addEventListener("change", render);
  ffEl.addEventListener("change", render);

  document.getElementById("reservaForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const r = calc();
    if (!r || r.error) { alert("Revisa fechas."); return; }

    const pickupAddress = dirEl.value.trim();
    if (!pickupAddress) {
      alert("Escribe la dirección de recogida.");
      dirEl.focus();
      return;
    }

    const payload = new URLSearchParams();
    payload.append("action", "save_reserva");
    payload.append("nombre", nombreEl.value);
    payload.append("email", emailEl.value);
    payload.append("pickup_address", pickupAddress);
    payload.append("fechaInicio", fiEl.value);
    payload.append("fechaFin", ffEl.value);
    payload.append("dias", String(r.dias));
    payload.append("auto_total", String(r.auto_total));

    const resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: payload.toString()
    });

    const data = await resp.json();
    if (!data.ok) { alert(data.error || "Error guardando reserva"); return; }

    // Guardar TODO para articulos.html
    localStorage.setItem("row_index", String(data.row_index));
    localStorage.setItem("nombre", data.nombre);
    localStorage.setItem("email", data.email);
    localStorage.setItem("pickup_address", pickupAddress);
    localStorage.setItem("fechaInicio", data.fechaInicio);
    localStorage.setItem("fechaFin", data.fechaFin);
    localStorage.setItem("dias", data.dias);
    localStorage.setItem("auto_total", String(data.auto_total));

    window.location.href = "articulos.html";
  });
</script>

</body>
</html>
