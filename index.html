<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reserva Audi Q5</title>
</head>
<body>

<form id="reservaForm" style="max-width:420px;margin:40px auto;padding:20px;border:1px solid #ccc;border-radius:12px;">
  <h3>Reserva tu Audi Q5</h3>

  <label>Nombre:</label><br>
  <input type="text" id="nombre" required style="width:100%;margin-bottom:10px;">

  <label>Email:</label><br>
  <input type="email" id="email" required style="width:100%;margin-bottom:10px;">

  <label>Dirección de recogida:</label><br>
  <input
    type="text"
    id="pickup_address"
    placeholder="Escribe la dirección de recogida"
    required
    style="width:100%;margin-bottom:10px;"
  >

  <label>Fecha Inicio:</label><br>
  <input type="date" id="fechaInicio" required style="width:100%;margin-bottom:10px;">

  <label>Fecha Fin:</label><br>
  <input type="date" id="fechaFin" required style="width:100%;margin-bottom:10px;">

  <p id="resultadoPrecio" style="font-weight:bold;margin:12px 0;text-align:center;"></p>

  <button type="submit" style="width:100%;padding:10px;background:#635bff;color:white;border:none;border-radius:8px;cursor:pointer;">
    Continuar → elegir artículos
  </button>
</form>

<!-- Google Places Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&libraries=places"></script>

<script>
  // Autocomplete dirección
  window.addEventListener("load", () => {
    const input = document.getElementById("pickup_address");
    new google.maps.places.Autocomplete(input, {
      types: ["geocode"],
      componentRestrictions: { country: "ca" }
    });
  });

  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw5GDkCLZVKSOt6wgXhDcOQBbLk2DVvYXVhDCDJE0NKDhICZGm_PCEituiavo_rqO7c/exec";

  const PRECIO_SEMANA = 100;
  const PRECIO_FINDE  = 135;

  const nombreEl = document.getElementById("nombre");
  const emailEl  = document.getElementById("email");
  const dirEl    = document.getElementById("pickup_address");
  const fiEl     = document.getElementById("fechaInicio");
  const ffEl     = document.getElementById("fechaFin");
  const outEl    = document.getElementById("resultadoPrecio");

  function calc() {
    if (!fiEl.value || !ffEl.value) return null;

    const inicio = new Date(fiEl.value);
    const fin = new Date(ffEl.value);
    const dias = Math.ceil((fin - inicio) / (1000*60*60*24));

    if (dias <= 0) return { error: "La fecha fin debe ser posterior." };

    let ds = 0, df = 0;
    const cur = new Date(inicio);
    while (cur < fin) {
      const d = cur.getDay();
      (d === 0 || d === 6) ? df++ : ds++;
      cur.setDate(cur.getDate() + 1);
    }

    return { dias, auto_total: ds * PRECIO_SEMANA + df * PRECIO_FINDE };
  }

  function render() {
    const r = calc();
    if (!r) return;
    if (r.error) { outEl.textContent = r.error; return; }
    outEl.innerHTML = `${r.dias} día(s) — <strong>Total: CA$ ${r.auto_total}</strong>`;
  }

  fiEl.addEventListener("change", render);
  ffEl.addEventListener("change", render);

  document.getElementById("reservaForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const r = calc();
    if (!r) return alert("Revisa las fechas.");
    if (!dirEl.value.trim()) return alert("Debes ingresar una dirección válida.");

    const payload = new URLSearchParams();
    payload.append("action", "save_reserva");
    payload.append("nombre", nombreEl.value);
    payload.append("email", emailEl.value);
    payload.append("pickup_address", dirEl.value);
    payload.append("fechaInicio", fiEl.value);
    payload.append("fechaFin", ffEl.value);
    payload.append("dias", r.dias);
    payload.append("auto_total", r.auto_total);

    const resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: payload.toString()
    });

    const data = await resp.json();
    if (!data.ok) return alert(data.error || "Error al guardar");

    localStorage.setItem("row_index", data.row_index);
    localStorage.setItem("pickup_address", dirEl.value);

    window.location.href = "articulos.html";
  });
</script>

</body>
</html>
